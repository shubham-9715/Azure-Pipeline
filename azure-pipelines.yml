trigger:
- main

# Use Microsoft-hosted Ubuntu agent
pool:
  vmImage: ubuntu-latest

stages:

# ----------------
# 1️⃣ Build Stage
# ----------------
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: BuildJob
    displayName: "Build C++ Project"
    container: mcr.microsoft.com/devcontainers/cpp:ubuntu-22.04
    steps:
    - checkout: self

    - script: |
        mkdir -p build
        cd build
        cmake ..
        cmake --build .
      displayName: "Configure and Build C++ Project"

    - publish: build
      artifact: BuildOutput
      displayName: "Publish build folder"

# ----------------
# 2️⃣ Test Stage
# ----------------
- stage: Test
  displayName: "Test Stage"
  dependsOn: Build
  jobs:

  # --- C++ Unit Test ---
  - job: CppUnitTest
    displayName: "C++ Unit Test"
    container: mcr.microsoft.com/devcontainers/cpp:ubuntu-22.04
    steps:
    - download: current
      artifact: BuildOutput

    - script: |
        cd $(Pipeline.Workspace)/BuildOutput
        ctest --output-on-failure
      displayName: "Run C++ Unit Tests"

  # --- Python Pytest ---
  - job: Pytest
    displayName: "Python Pytest"
    container: mcr.microsoft.com/devcontainers/python:ubuntu-22.04
    steps:
    - checkout: self

    - script: |
        # Create virtual environment
        python3 -m venv venv_pytest
        source venv_pytest/bin/activate

        # Upgrade pip and install pytest
        pip install --upgrade pip pytest

        # Run tests
        pytest pytests -v
      displayName: "Run Python Pytest"
